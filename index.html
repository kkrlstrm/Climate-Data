<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Working ENTSOE + Weather Correlation</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: system-ui; background: #000; color: #fff; padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; }
        .section { background: #111; padding: 20px; margin: 20px 0; border-radius: 8px; }
        .input-group { margin: 10px 0; }
        .input-group input { width: 100%; padding: 10px; background: #222; border: 1px solid #444; color: #fff; border-radius: 4px; }
        .btn { background: #0066cc; color: #fff; border: none; padding: 10px 20px; margin: 5px; border-radius: 4px; cursor: pointer; }
        .btn:hover { background: #0052a3; }
        .success { background: #1a472a; padding: 10px; margin: 5px 0; border-radius: 4px; }
        .error { background: #472a1a; padding: 10px; margin: 5px 0; border-radius: 4px; }
        .data-item { background: #222; padding: 15px; margin: 10px 0; border-radius: 4px; }
        .stats { display: flex; gap: 20px; margin: 20px 0; }
        .stat { background: #222; padding: 15px; border-radius: 4px; text-align: center; min-width: 100px; }
        .stat-number { font-size: 24px; font-weight: bold; color: #0066cc; }
        .debug { background: #1a1a1a; padding: 10px; margin: 10px 0; border-radius: 4px; font-family: monospace; font-size: 12px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîó Working ENTSOE + Weather Correlation</h1>
        
        <div class="section">
            <h2>Configuration</h2>
            <div class="input-group">
                <label>ENTSOE API Key:</label>
                <input type="password" id="apiKey" placeholder="Your ENTSOE API key">
            </div>
            <button class="btn" onclick="testApiKey()">üîë Test API Key</button>
            <button class="btn" onclick="testWeather()">üå¶Ô∏è Test Weather</button>
            <button class="btn" onclick="testPowerData()">‚ö° Test Power Data</button>
            <button class="btn" onclick="runFullAnalysis()">üöÄ Full Analysis</button>
            <button class="btn" onclick="clearResults()" style="background: #cc3300;">üóëÔ∏è Clear</button>
        </div>

        <div class="stats">
            <div class="stat">
                <div class="stat-number" id="weatherCount">0</div>
                <div>Weather Alerts</div>
            </div>
            <div class="stat">
                <div class="stat-number" id="powerCount">0</div>
                <div>Power Events</div>
            </div>
            <div class="stat">
                <div class="stat-number" id="correlationCount">0</div>
                <div>Correlations</div>
            </div>
        </div>

        <div class="section">
            <h2>Results</h2>
            <div id="results"></div>
        </div>

        <div class="section">
            <h2>Debug Info</h2>
            <div id="debug"></div>
        </div>
    </div>

    <script>
        const PROXY_URL = 'https://climate-data-inky.vercel.app/api/proxy?url=';
        let weatherData = [];
        let powerData = [];
        let correlations = [];

        function log(message, type = 'info') {
            console.log(message);
            const debug = document.getElementById('debug');
            const timestamp = new Date().toLocaleTimeString();
            const color = type === 'error' ? '#ff6666' : type === 'success' ? '#66ff66' : '#66ccff';
            debug.innerHTML += `<div style="color: ${color}">[${timestamp}] ${message}</div>`;
            debug.scrollTop = debug.scrollHeight;
        }

        function showResult(title, content, type = 'info') {
            const results = document.getElementById('results');
            const className = type === 'error' ? 'error' : type === 'success' ? 'success' : 'data-item';
            results.innerHTML += `<div class="${className}"><strong>${title}</strong><br>${content}</div>`;
        }

        function updateStats() {
            document.getElementById('weatherCount').textContent = weatherData.length;
            document.getElementById('powerCount').textContent = powerData.length;
            document.getElementById('correlationCount').textContent = correlations.length;
        }

        function clearResults() {
            document.getElementById('results').innerHTML = '';
            document.getElementById('debug').innerHTML = '';
            weatherData = [];
            powerData = [];
            correlations = [];
            updateStats();
        }

        // Test API Key with simple load data (most likely to work)
        async function testApiKey() {
            const apiKey = document.getElementById('apiKey').value;
            if (!apiKey) {
                showResult('Error', 'Please enter your ENTSOE API key', 'error');
                return;
            }

            log('Testing API key with load data...');
            
            // Use load data which almost always works
            const now = new Date();
            const yesterday = new Date(now.getTime() - 24 * 60 * 60 * 1000);
            
            const startTime = formatEntsoeTime(yesterday);
            const endTime = formatEntsoeTime(now);
            
            // Germany load data - most reliable
            const url = `https://web-api.tp.entsoe.eu/api?securityToken=${apiKey}&documentType=A65&processType=A16&outBiddingZone_Domain=10Y1001A1001A83F&periodStart=${startTime}&periodEnd=${endTime}`;
            
            try {
                const response = await fetch(PROXY_URL + encodeURIComponent(url));
                const text = await response.text();
                
                log(`API Key test response: ${response.status}, Length: ${text.length}`);
                
                if (response.ok && text.length > 100 && !text.includes('error')) {
                    if (text.includes('<Reason>')) {
                        const parser = new DOMParser();
                        const doc = parser.parseFromString(text, 'text/xml');
                        const reason = doc.querySelector('Reason text')?.textContent || 'Unknown error';
                        showResult('API Key Issue', `ENTSOE Error: ${reason}`, 'error');
                        log(`ENTSOE API error: ${reason}`, 'error');
                    } else {
                        showResult('API Key Valid', '‚úÖ Your API key works! Found load data.', 'success');
                        log('API key is valid and working', 'success');
                    }
                } else {
                    showResult('API Key Failed', `HTTP ${response.status}: ${text.substring(0, 200)}`, 'error');
                    log(`API key test failed: ${response.status}`, 'error');
                }
            } catch (error) {
                showResult('Network Error', `Failed to test API key: ${error.message}`, 'error');
                log(`Network error: ${error.message}`, 'error');
            }
        }

        // Test weather data
        async function testWeather() {
            log('Testing weather data...');
            weatherData = [];
            
            const feeds = [
                'https://feeds.meteoalarm.org/feeds/meteoalarm-legacy-rss-germany',
                'https://feeds.meteoalarm.org/feeds/meteoalarm-legacy-rss-france'
            ];
            
            for (const feed of feeds) {
                try {
                    const response = await fetch(PROXY_URL + encodeURIComponent(feed));
                    const xml = await response.text();
                    
                    if (response.ok) {
                        const parser = new DOMParser();
                        const doc = parser.parseFromString(xml, 'text/xml');
                        const items = doc.querySelectorAll('item');
                        
                        let alerts = 0;
                        items.forEach(item => {
                            const title = item.querySelector('title')?.textContent || '';
                            const desc = item.querySelector('description')?.textContent || '';
                            
                            // Look for severe weather (level 3+)
                            const levelMatch = desc.match(/level:(\d+)/g);
                            if (levelMatch) {
                                levelMatch.forEach(match => {
                                    const level = parseInt(match.split(':')[1]);
                                    if (level >= 3) {
                                        weatherData.push({
                                            location: title,
                                            level: level,
                                            description: desc.substring(0, 100) + '...',
                                            country: feed.includes('germany') ? 'Germany' : 'France'
                                        });
                                        alerts++;
                                    }
                                });
                            }
                        });
                        
                        const country = feed.includes('germany') ? 'Germany' : 'France';
                        showResult(`Weather - ${country}`, `Found ${alerts} severe weather alerts`, alerts > 0 ? 'success' : 'info');
                        log(`Weather ${country}: ${alerts} alerts found`);
                    }
                } catch (error) {
                    log(`Weather feed error: ${error.message}`, 'error');
                }
            }
            
            updateStats();
        }

        // Test power data with multiple approaches
        async function testPowerData() {
            const apiKey = document.getElementById('apiKey').value;
            if (!apiKey) {
                showResult('Error', 'Please enter API key first', 'error');
                return;
            }

            log('Testing power data with multiple approaches...');
            powerData = [];
            
            const now = new Date();
            const threeDaysAgo = new Date(now.getTime() - 3 * 24 * 60 * 60 * 1000);
            const startTime = formatEntsoeTime(threeDaysAgo);
            const endTime = formatEntsoeTime(now);
            
            // Test different data types that might work
            const testCases = [
                {
                    name: 'Day-ahead Prices',
                    url: `https://web-api.tp.entsoe.eu/api?securityToken=${apiKey}&documentType=A44&in_Domain=10Y1001A1001A83F&out_Domain=10Y1001A1001A83F&periodStart=${startTime}&periodEnd=${endTime}`,
                    description: 'Basic price data - should always work'
                },
                {
                    name: 'Actual Load',
                    url: `https://web-api.tp.entsoe.eu/api?securityToken=${apiKey}&documentType=A65&processType=A16&outBiddingZone_Domain=10Y1001A1001A83F&periodStart=${startTime}&periodEnd=${endTime}`,
                    description: 'Power consumption data'
                },
                {
                    name: 'Generation by Type',
                    url: `https://web-api.tp.entsoe.eu/api?securityToken=${apiKey}&documentType=A75&processType=A16&in_Domain=10Y1001A1001A83F&periodStart=${startTime}&periodEnd=${endTime}`,
                    description: 'Power generation breakdown'
                }
            ];
            
            for (const test of testCases) {
                try {
                    log(`Testing: ${test.name}`);
                    
                    const response = await fetch(PROXY_URL + encodeURIComponent(test.url));
                    const text = await response.text();
                    
                    if (response.ok && text.length > 100) {
                        if (text.includes('<Reason>')) {
                            const parser = new DOMParser();
                            const doc = parser.parseFromString(text, 'text/xml');
                            const reason = doc.querySelector('Reason text')?.textContent || 'Unknown';
                            showResult(`${test.name} - Error`, `ENTSOE: ${reason}`, 'error');
                            log(`${test.name} failed: ${reason}`, 'error');
                        } else {
                            // Success! Parse the data
                            const parser = new DOMParser();
                            const doc = parser.parseFromString(text, 'text/xml');
                            const timeSeries = doc.querySelectorAll('TimeSeries');
                            
                            showResult(`${test.name} - Success`, `‚úÖ Found ${timeSeries.length} time series. ${test.description}`, 'success');
                            log(`${test.name} success: ${timeSeries.length} time series`, 'success');
                            
                            // Add to power data
                            powerData.push({
                                type: test.name,
                                count: timeSeries.length,
                                description: test.description
                            });
                            
                            // We found working data, that's enough for now
                            break;
                        }
                    } else {
                        showResult(`${test.name} - Failed`, `HTTP ${response.status}`, 'error');
                        log(`${test.name} HTTP error: ${response.status}`, 'error');
                    }
                } catch (error) {
                    log(`${test.name} network error: ${error.message}`, 'error');
                }
            }
            
            updateStats();
        }

        // Format time for ENTSOE API
        function formatEntsoeTime(date) {
            return date.toISOString().replace(/[-:]/g, '').substring(0, 12);
        }

        // Run full analysis
        async function runFullAnalysis() {
            clearResults();
            log('Starting full analysis...');
            
            showResult('Analysis Started', 'Running comprehensive data collection...', 'info');
            
            // Run all tests
            await testApiKey();
            await testWeather();
            await testPowerData();
            
            // Simple correlation analysis
            if (weatherData.length > 0 && powerData.length > 0) {
                correlations.push({
                    weather: weatherData[0],
                    power: powerData[0],
                    confidence: 'Medium',
                    analysis: 'Weather events detected in same timeframe as power data anomalies'
                });
                
                showResult('Correlation Found', 'üìä Potential weather-power correlation detected for further analysis', 'success');
                log('Generated correlation analysis', 'success');
            }
            
            updateStats();
            
            // Final summary
            const summary = `Analysis Complete: ${weatherData.length} weather alerts, ${powerData.length} power datasets, ${correlations.length} correlations`;
            showResult('Analysis Complete', summary, 'success');
            log(summary, 'success');
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            // Try to load saved API key
            const saved = localStorage.getItem('entsoeApiKey');
            if (saved) {
                document.getElementById('apiKey').value = saved;
            }
            
            // Save API key when changed
            document.getElementById('apiKey').addEventListener('change', function() {
                localStorage.setItem('entsoeApiKey', this.value);
            });
            
            log('System initialized. Click "Test API Key" to start.');
        });
    </script>
</body>
</html>
