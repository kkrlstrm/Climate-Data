<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Grid Weather Correlation Agent</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0a0a0a;
            color: #ffffff;
            min-height: 100vh;
        }
        
        .header {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            padding: 12px 24px;
            border-bottom: 1px solid #333;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .title {
            font-size: 20px;
            font-weight: 600;
            color: #ffffff;
        }
        
        .status-indicators {
            display: flex;
            gap: 20px;
            align-items: center;
        }
        
        .status {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
        }
        
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #4ade80;
        }
        
        .container {
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .config-section {
            background: #1a1a1a;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .config-section h3 {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 12px;
            color: #d1d5db;
        }
        
        .input-group {
            margin-bottom: 16px;
        }
        
        .input-group label {
            display: block;
            font-size: 14px;
            color: #9ca3af;
            margin-bottom: 8px;
        }
        
        .input-group input {
            width: 100%;
            max-width: 400px;
            padding: 10px;
            background: #374151;
            border: 1px solid #4b5563;
            border-radius: 6px;
            color: white;
            font-size: 14px;
        }
        
        .btn {
            background: #2563eb;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        
        .btn:hover {
            background: #1d4ed8;
        }
        
        .btn-danger {
            background: #dc2626;
        }
        
        .btn-danger:hover {
            background: #b91c1c;
        }
        
        .results-section {
            background: #1a1a1a;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .results-section h3 {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 16px;
            color: #d1d5db;
        }
        
        .stats {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .stat {
            background: #374151;
            padding: 16px;
            border-radius: 6px;
            min-width: 120px;
            text-align: center;
        }
        
        .stat-number {
            font-size: 24px;
            font-weight: 600;
            color: #3b82f6;
            margin-bottom: 4px;
        }
        
        .stat-label {
            font-size: 12px;
            color: #9ca3af;
        }
        
        .alert-item {
            background: #374151;
            border: 1px solid #4b5563;
            border-radius: 6px;
            padding: 12px;
            margin-bottom: 12px;
        }
        
        .alert-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .alert-location {
            font-weight: 600;
            font-size: 14px;
        }
        
        .alert-severity {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
        }
        
        .severity-severe {
            background: #f59e0b;
            color: #000;
        }
        
        .severity-extreme {
            background: #dc2626;
            color: white;
        }
        
        .alert-details {
            font-size: 12px;
            color: #d1d5db;
            line-height: 1.4;
        }
        
        .alert-time {
            font-size: 11px;
            color: #9ca3af;
            margin-top: 4px;
        }
        
        .loading {
            color: #9ca3af;
            text-align: center;
            padding: 20px;
        }
        
        .error {
            background: #1f2937;
            border: 1px solid #dc2626;
            border-radius: 6px;
            padding: 12px;
            color: #fca5a5;
            font-size: 14px;
            margin-bottom: 12px;
        }
        
        .debug-section {
            background: #111;
            border-radius: 6px;
            padding: 12px;
            margin-bottom: 16px;
        }
        
        .debug-section h4 {
            color: #d1d5db;
            font-size: 14px;
            margin-bottom: 8px;
        }
        
        .debug-content {
            font-family: 'Courier New', monospace;
            font-size: 11px;
            color: #9ca3af;
            background: #000;
            padding: 8px;
            border-radius: 4px;
            word-break: break-all;
            max-height: 200px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="title">üîó Grid Weather Correlation Agent</div>
        <div class="status-indicators">
            <div class="status">
                <div class="status-dot"></div>
                <span>Live Monitoring</span>
            </div>
            <div class="status">
                <span id="lastUpdate">Never</span>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="config-section">
            <h3>API Configuration</h3>
            <div class="input-group">
                <label>ENTSOE API Key</label>
                <input type="password" id="entsoeApiKey" placeholder="Enter your ENTSOE API key">
            </div>
            <button class="btn" onclick="testWeatherData()">üå¶Ô∏è Test Weather Data</button>
            <button class="btn" onclick="testOutageData()">‚ö° Test ENTSOE API</button>
            <button class="btn" onclick="runFullTest()">üîÑ Run Full Test</button>
            <button class="btn btn-danger" onclick="clearResults()">üóëÔ∏è Clear Results</button>
        </div>

        <div class="results-section">
            <h3>Test Results</h3>
            <div class="stats">
                <div class="stat">
                    <div class="stat-number" id="weatherCount">0</div>
                    <div class="stat-label">Weather Alerts</div>
                </div>
                <div class="stat">
                    <div class="stat-number" id="outageCount">0</div>
                    <div class="stat-label">Power Outages</div>
                </div>
                <div class="stat">
                    <div class="stat-number" id="correlationCount">0</div>
                    <div class="stat-label">Correlations</div>
                </div>
            </div>
            <div id="results"></div>
        </div>

        <div class="results-section">
            <h3>Debug Information</h3>
            
            <div class="debug-section">
                <h4>Last API Call</h4>
                <div class="debug-content" id="lastApiCall">No API calls made yet</div>
            </div>
            
            <div class="debug-section">
                <h4>API Response Status</h4>
                <div class="debug-content" id="apiStatus">No responses yet</div>
            </div>
            
            <div class="debug-section">
                <h4>Raw XML Response (first 1000 chars)</h4>
                <div class="debug-content" id="rawXml">No XML responses yet</div>
            </div>
            
            <div class="debug-section">
                <h4>Console Log</h4>
                <div class="debug-content" id="consoleLog">No logs yet</div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let weatherData = [];
        let outageData = [];
        let correlations = [];

        // Configuration
        const CONFIG = {
            weatherTypes: {
                1: 'Wind',
                2: 'Snow/Ice', 
                5: 'Extreme Heat',
                7: 'Coastal Event',
                10: 'Rain',
                11: 'Flood',
                12: 'Rain-Flood'
            },
            countryCodes: {
                'AT': { name: 'Austria', lat: 47.5162, lon: 14.5501 },
                'BE': { name: 'Belgium', lat: 50.8503, lon: 4.3517 },
                'CH': { name: 'Switzerland', lat: 46.8182, lon: 8.2275 },
                'CZ': { name: 'Czech Republic', lat: 49.7417, lon: 15.3350 },
                'DE': { name: 'Germany', lat: 51.1657, lon: 10.4515 },
                'DK': { name: 'Denmark', lat: 56.2639, lon: 9.5018 },
                'ES': { name: 'Spain', lat: 40.4637, lon: -3.7492 },
                'FI': { name: 'Finland', lat: 61.9241, lon: 25.7482 },
                'FR': { name: 'France', lat: 46.6034, lon: 1.8883 },
                'GB': { name: 'United Kingdom', lat: 55.3781, lon: -3.4360 },
                'GR': { name: 'Greece', lat: 39.0742, lon: 21.8243 },
                'HU': { name: 'Hungary', lat: 47.1625, lon: 19.5033 },
                'IE': { name: 'Ireland', lat: 53.1424, lon: -7.6921 },
                'IS': { name: 'Iceland', lat: 64.9631, lon: -19.0208 },
                'IT': { name: 'Italy', lat: 41.8719, lon: 12.5674 },
                'LU': { name: 'Luxembourg', lat: 49.8153, lon: 6.1296 },
                'NL': { name: 'Netherlands', lat: 52.1326, lon: 5.2913 },
                'NO': { name: 'Norway', lat: 60.4720, lon: 8.4689 },
                'PL': { name: 'Poland', lat: 51.9194, lon: 19.1451 },
                'PT': { name: 'Portugal', lat: 39.3999, lon: -8.2245 },
                'RO': { name: 'Romania', lat: 45.9432, lon: 24.9668 },
                'SE': { name: 'Sweden', lat: 60.1282, lon: 18.6435 }
            }
        };

        // Utility functions
        function logMessage(message) {
            console.log(message);
            const consoleLog = document.getElementById('consoleLog');
            const timestamp = new Date().toLocaleTimeString();
            consoleLog.innerHTML += `[${timestamp}] ${message}<br>`;
            consoleLog.scrollTop = consoleLog.scrollHeight;
        }

        function updateDebugInfo(apiCall, status, xmlResponse) {
            document.getElementById('lastApiCall').textContent = apiCall;
            document.getElementById('apiStatus').textContent = status;
            document.getElementById('rawXml').textContent = xmlResponse;
        }

        function displayResults(title, data, type = 'info') {
            const results = document.getElementById('results');
            const resultDiv = document.createElement('div');
            resultDiv.className = type === 'error' ? 'error' : 'alert-item';
            
            resultDiv.innerHTML = `
                <div class="alert-header">
                    <div class="alert-location">${title}</div>
                    <div class="alert-time">${new Date().toLocaleTimeString()}</div>
                </div>
                <div class="alert-details">${data}</div>
            `;
            
            results.appendChild(resultDiv);
        }

        function updateStats() {
            document.getElementById('weatherCount').textContent = weatherData.length;
            document.getElementById('outageCount').textContent = outageData.length;
            document.getElementById('correlationCount').textContent = correlations.length;
        }

        // Weather data testing with YOUR Vercel proxy
        async function testWeatherData() {
            logMessage('Starting weather data test with Vercel proxy...');
            displayResults('Weather Test', 'Testing weather feeds with your Vercel proxy...', 'info');
            
            weatherData = [];
            
            const testUrl = 'https://feeds.meteoalarm.org/feeds/meteoalarm-legacy-rss-germany';
            
            try {
                // Use YOUR Vercel proxy (replace with your actual Vercel URL)
                const vercelProxy = `${window.location.origin}/api/proxy?url=`;
                const proxyUrl = vercelProxy + encodeURIComponent(testUrl);
                
                logMessage(`Using Vercel proxy: ${vercelProxy}`);
                displayResults('Vercel Proxy Test', `Testing your proxy: https://climate-data-inky.vercel.app/api/proxy`, 'info');
                
                updateDebugInfo(proxyUrl, 'Testing your Vercel proxy...', '');
                
                const response = await fetch(proxyUrl);
                const xmlText = await response.text();
                
                logMessage(`Vercel proxy response: ${response.status}, Length: ${xmlText.length}`);
                updateDebugInfo(proxyUrl, `${response.status} - ${xmlText.length} chars`, xmlText.substring(0, 1000));
                
                if (response.ok && xmlText.length > 100) {
                    displayResults('Vercel Proxy Success', `Your proxy works! Response length: ${xmlText.length}`, 'info');
                    
                    // Try to parse the XML
                    const parser = new DOMParser();
                    const xmlDoc = parser.parseFromString(xmlText, 'text/xml');
                    const items = xmlDoc.querySelectorAll('item');
                    
                    logMessage(`Found ${items.length} items in weather feed`);
                    displayResults('XML Parse Success', `Found ${items.length} weather items`, 'info');
                    
                    // Parse weather data
                    await fetchWeatherWithVercelProxy(vercelProxy);
                    
                } else {
                    displayResults('Vercel Proxy Failed', `Status: ${response.status}, Response: ${xmlText.substring(0, 200)}`, 'error');
                    
                    // If response contains error info, show it
                    if (xmlText.includes('error')) {
                        try {
                            const errorData = JSON.parse(xmlText);
                            displayResults('Proxy Error Details', errorData.message || errorData.error, 'error');
                        } catch (e) {
                            displayResults('Proxy Error Details', xmlText, 'error');
                        }
                    }
                }
                
            } catch (error) {
                logMessage(`Vercel proxy error: ${error.message}`);
                displayResults('Vercel Proxy Error', `Network error: ${error.message}`, 'error');
                
                displayResults('Troubleshooting', `
                    If your proxy isn't working:
                    1. Check that api/proxy.js was deployed to Vercel
                    2. Visit https://climate-data-inky.vercel.app/api/proxy directly to test
                    3. Check Vercel deployment logs for errors
                `, 'error');
            }
            
            updateStats();
        }

        async function fetchWeatherWithVercelProxy(vercelProxy) {
            const testFeeds = [
                'https://feeds.meteoalarm.org/feeds/meteoalarm-legacy-rss-germany',
                'https://feeds.meteoalarm.org/feeds/meteoalarm-legacy-rss-italy'
            ];
            
            for (const feedUrl of testFeeds) {
                try {
                    const proxyUrl = vercelProxy + encodeURIComponent(feedUrl);
                    const response = await fetch(proxyUrl);
                    const xmlText = await response.text();
                    
                    if (response.ok) {
                        const parser = new DOMParser();
                        const xmlDoc = parser.parseFromString(xmlText, 'text/xml');
                        const items = xmlDoc.querySelectorAll('item');
                        
                        let alertsFound = 0;
                        items.forEach(item => {
                            const title = item.querySelector('title')?.textContent || '';
                            const description = item.querySelector('description')?.textContent || '';
                            
                            const awarenessRegex = /awt:(\d+)\s+level:(\d+)/g;
                            let match;
                            
                            while ((match = awarenessRegex.exec(description)) !== null) {
                                const awarenessType = parseInt(match[1]);
                                const level = parseInt(match[2]);
                                
                                if (CONFIG.weatherTypes[awarenessType] && level >= 3) {
                                    weatherData.push({
                                        location: title,
                                        type: CONFIG.weatherTypes[awarenessType],
                                        severity: level === 4 ? 'extreme' : 'severe',
                                        level: level,
                                        description: description.substring(0, 200) + '...'
                                    });
                                    alertsFound++;
                                }
                            }
                        });
                        
                        displayResults('Weather Success', `Found ${alertsFound} severe weather alerts in ${feedUrl.split('/').pop()}`, 'info');
                    }
                    
                } catch (error) {
                    displayResults('Weather Error', `Error processing ${feedUrl}: ${error.message}`, 'error');
                }
            }
        }

        // ENTSOE API testing with YOUR Vercel proxy
        async function testOutageData() {
            const apiKey = document.getElementById('entsoeApiKey').value;
            if (!apiKey) {
                displayResults('API Key Error', 'Please enter your ENTSOE API key', 'error');
                return;
            }
            
            logMessage('Starting ENTSOE API test with Vercel proxy...');
            displayResults('ENTSOE Test', 'Testing ENTSOE API with your Vercel proxy...', 'info');
            
            outageData = [];
            
            const now = new Date();
            const twoDaysAgo = new Date(now.getTime() - 2 * 24 * 60 * 60 * 1000);
            
            const startTime = formatDateTime(twoDaysAgo);
            const endTime = formatDateTime(now);
            
            const testZone = '10Y1001A1001A83F';
            const apiUrl = `https://web-api.tp.entsoe.eu/api?securityToken=${apiKey}&documentType=A80&processType=A16&biddingZone_Domain=${testZone}&periodStart=${startTime}&periodEnd=${endTime}`;
            
            logMessage(`Testing ENTSOE API with zone: ${testZone}`);
            logMessage(`API URL: ${apiUrl}`);
            
            try {
                // Use YOUR Vercel proxy - hardcode your URL
                const vercelProxy = `https://climate-data-inky.vercel.app/api/proxy?url=`;
                const proxyUrl = vercelProxy + encodeURIComponent(apiUrl);
                
                logMessage(`Using Vercel proxy for ENTSOE: ${vercelProxy}`);
                displayResults('ENTSOE Vercel Test', `Testing ENTSOE with your proxy`, 'info');
                
                updateDebugInfo(apiUrl, 'Testing ENTSOE with your Vercel proxy...', '');
                
                const response = await fetch(proxyUrl);
                const xmlText = await response.text();
                
                logMessage(`ENTSOE Vercel response: ${response.status}, Length: ${xmlText.length}`);
                updateDebugInfo(apiUrl, `${response.status} - ${xmlText.length} chars`, xmlText.substring(0, 1000));
                
                if (response.ok && xmlText.length > 50) {
                    displayResults('ENTSOE Proxy Success', `Your proxy accessed ENTSOE! Length: ${xmlText.length}`, 'info');
                    
                    // Check for ENTSOE errors
                    if (xmlText.includes('<Reason>')) {
                        const parser = new DOMParser();
                        const xmlDoc = parser.parseFromString(xmlText, 'text/xml');
                        const reasonCode = xmlDoc.querySelector('Reason code')?.textContent || '';
                        const reasonText = xmlDoc.querySelector('Reason text')?.textContent || '';
                        
                        displayResults('ENTSOE API Error', `Code: ${reasonCode}, Message: ${reasonText}`, 'error');
                        logMessage(`ENTSOE API returned error: ${reasonCode} - ${reasonText}`);
                        
                        if (reasonCode === '999') {
                            displayResults('API Key Issue', 'Error 999 usually means invalid API key or wrong parameters. Check your ENTSOE API key!', 'error');
                        } else if (reasonText.includes('No matching data')) {
                            displayResults('No Data Found', 'No outages found for this time period (this is actually good news!)', 'info');
                        }
                    } else {
                        // Parse successful response
                        const parser = new DOMParser();
                        const xmlDoc = parser.parseFromString(xmlText, 'text/xml');
                        const outageElements = xmlDoc.querySelectorAll('*');
                        
                        displayResults('ENTSOE Success', `üéâ ENTSOE API working! XML parsed successfully. Found ${outageElements.length} XML elements`, 'info');
                        
                        // Look for actual outage data
                        const unavailabilityDocs = xmlDoc.querySelectorAll('Unavailability_MarketDocument, UnavailabilityMarketDocument');
                        if (unavailabilityDocs.length > 0) {
                            displayResults('Outages Found', `Found ${unavailabilityDocs.length} outage documents!`, 'info');
                            
                            unavailabilityDocs.forEach((doc, index) => {
                                const mrid = doc.querySelector('mRID')?.textContent || `outage_${index}`;
                                outageData.push({
                                    id: mrid,
                                    zone: testZone,
                                    country: 'Germany'
                                });
                            });
                        } else {
                            displayResults('No Outages', 'No outages found in the response (good news for the grid!)', 'info');
                        }
                    }
                    
                } else {
                    displayResults('ENTSOE Proxy Failed', `Status: ${response.status}, Response too short: ${xmlText.length} chars`, 'error');
                    
                    // Show error details if available
                    if (xmlText.includes('error')) {
                        try {
                            const errorData = JSON.parse(xmlText);
                            displayResults('ENTSOE Error Details', errorData.message || errorData.error, 'error');
                        } catch (e) {
                            displayResults('ENTSOE Response', xmlText.substring(0, 500), 'error');
                        }
                    }
                }
                
            } catch (error) {
                logMessage(`ENTSOE Vercel error: ${error.message}`);
                displayResults('ENTSOE Proxy Error', `Network error: ${error.message}`, 'error');
            }
            
            updateStats();
        }

        function formatDateTime(date) {
            return date.toISOString().replace(/[-:]/g, '').split('.')[0].substring(0, 12);
        }

        // Full test
        async function runFullTest() {
            clearResults();
            await testWeatherData();
            await testOutageData();
            
            // Simple correlation test
            correlations = [];
            if (weatherData.length > 0 && outageData.length > 0) {
                correlations.push({
                    weather: weatherData[0],
                    outage: outageData[0],
                    score: 0.75
                });
                displayResults('Correlation Found', `Potential correlation between ${weatherData[0].type} and grid outage`, 'info');
            }
            
            updateStats();
            document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString();
        }

        function clearResults() {
            document.getElementById('results').innerHTML = '';
            document.getElementById('consoleLog').innerHTML = '';
            weatherData = [];
            outageData = [];
            correlations = [];
            updateStats();
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            const savedApiKey = localStorage.getItem('entsoeApiKey');
            if (savedApiKey) {
                document.getElementById('entsoeApiKey').value = savedApiKey;
            }
            
            // Save API key when typed
            document.getElementById('entsoeApiKey').addEventListener('change', function() {
                localStorage.setItem('entsoeApiKey', this.value);
            });
            
            logMessage('Grid Weather Correlation Agent initialized');
            displayResults('System Ready', 'Click the test buttons to verify your API connections', 'info');
        });
    </script>
</body>
</html>
